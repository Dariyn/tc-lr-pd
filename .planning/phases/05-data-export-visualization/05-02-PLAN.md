---
phase: 05-data-export-visualization
plan: 02
type: execute
wave: 1
depends_on: []
files_modified: [src/visualization/__init__.py, src/visualization/chart_generator.py, tests/test_chart_generator.py, requirements.txt]
autonomous: true
---

<objective>
Generate static charts (PNG/SVG) visualizing analysis findings for embedding in reports and presentations.

Purpose: Create publication-ready visualizations of equipment rankings, seasonal trends, vendor performance, and failure patterns. Charts should be clear, professional, and suitable for stakeholder presentations.

Output: ChartGenerator class with methods to create bar charts, line charts, and heatmaps for each analysis type, saved as PNG and SVG files.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Phase dependencies - what data we're visualizing
@.planning/phases/02-equipment-category-analysis/02-03-SUMMARY.md
@.planning/phases/03-cost-pattern-analysis/03-01-SUMMARY.md
@.planning/phases/03-cost-pattern-analysis/03-02-SUMMARY.md
@.planning/phases/03-cost-pattern-analysis/03-03-SUMMARY.md

# Source code to understand data structures
@src/reporting/report_builder.py
@src/analysis/equipment_ranker.py
@src/analysis/seasonal_analyzer.py
@src/analysis/vendor_analyzer.py
@src/analysis/failure_pattern_analyzer.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Set up matplotlib and implement equipment ranking charts</name>
  <files>requirements.txt, src/visualization/__init__.py, src/visualization/chart_generator.py</files>
  <action>
Add matplotlib==3.8.2 to requirements.txt for static chart generation (industry standard, no dependencies on web frameworks).

Create src/visualization/ directory and ChartGenerator class with:
- __init__(self, style='default', dpi=300): Initialize with configurable style and DPI for print quality
- create_equipment_ranking_chart(df, output_path, top_n=10, format='png'):
  * Horizontal bar chart of top N equipment by priority_score
  * Y-axis: equipment names, X-axis: priority score
  * Color bars by category (use categorical colormap)
  * Add data labels showing work_order_count on bars
  * Title: "Top Equipment by Maintenance Priority"
  * Save as PNG (default) or SVG based on format parameter
  * Handle edge cases: empty df, fewer than top_n items, missing columns

Use matplotlib.pyplot for plotting. Set figure size to (10, 6) for readability. Use plt.tight_layout() to prevent label cutoff. Style with professional colors matching report theme (dark blue #1f4788 for bars). Add grid for readability.

Export __init__.py: from .chart_generator import ChartGenerator
  </action>
  <verify>pytest tests/test_chart_generator.py -v -k equipment</verify>
  <done>matplotlib added, ChartGenerator class created, equipment ranking chart method works for PNG and SVG formats</done>
</task>

<task type="auto">
  <name>Task 2: Implement seasonal trend and vendor performance charts</name>
  <files>src/visualization/chart_generator.py</files>
  <action>
Add chart methods to ChartGenerator class:

create_seasonal_trend_chart(patterns_dict, output_path, format='png'):
- Line chart showing cost trends over months
- X-axis: months (Jan-Dec), Y-axis: total cost
- Two lines: total_cost (solid blue) and work_order_count (dashed orange, secondary Y-axis)
- Title: "Seasonal Cost and Work Order Trends"
- Legend in upper right
- Format both Y-axes with currency ($) and count labels
- Handle edge cases: missing months, single data point, all zero values

create_vendor_performance_chart(df, output_path, top_n=10, format='png'):
- Grouped bar chart comparing vendors on multiple metrics
- Groups: top N vendors by total_cost
- Bars per vendor: total_cost (blue), avg_cost (orange), cost_efficiency (green)
- X-axis: vendor names (rotate 45Â° if long), Y-axis: cost ($)
- Title: "Vendor Cost Performance Comparison"
- Legend showing metrics
- Handle edge cases: empty df, single vendor, missing metrics

Use consistent styling: figure size (12, 6) for trend/vendor charts, same color scheme, grid lines, tight_layout.
  </action>
  <verify>pytest tests/test_chart_generator.py -v -k "seasonal or vendor"</verify>
  <done>Seasonal and vendor charts implemented with proper formatting, legends, and edge case handling</done>
</task>

<task type="auto">
  <name>Task 3: Add failure pattern charts and comprehensive tests</name>
  <files>src/visualization/chart_generator.py, tests/test_chart_generator.py</files>
  <action>
Add to ChartGenerator:

create_failure_pattern_chart(patterns_list, output_path, top_n=10, format='png'):
- Horizontal bar chart of top N patterns by impact_score
- Y-axis: pattern phrases, X-axis: impact score
- Color bars by category (leak=blue, electrical=orange, mechanical=green, other=gray)
- Add annotation showing frequency count on each bar
- Title: "High-Impact Failure Patterns"
- Handle edge cases: empty patterns, uncategorized patterns, ties in ranking

Create comprehensive test suite (tests/test_chart_generator.py):

Chart generation tests (12 tests):
- test_equipment_ranking_chart_png: Verify PNG file created, correct size
- test_equipment_ranking_chart_svg: Verify SVG format works
- test_equipment_chart_top_n: Verify limiting to top N items
- test_seasonal_trend_chart: Verify dual Y-axis line chart
- test_seasonal_missing_months: Handle sparse data
- test_vendor_performance_chart: Verify grouped bars
- test_vendor_single_vendor: Handle edge case
- test_failure_pattern_chart: Verify pattern visualization
- test_failure_pattern_categories: Verify color coding by category
- test_chart_empty_data: All methods handle empty data gracefully
- test_chart_file_formats: Both PNG and SVG work for all chart types
- test_chart_custom_style: Verify style parameter works

Use pytest fixtures for sample data. Use tmp_path for output files. Verify file existence, file size > 0, and format correctness (PNG magic bytes b'\\x89PNG', SVG starts with '<svg' or '<?xml').
  </action>
  <verify>pytest tests/test_chart_generator.py -v --cov=src/visualization</verify>
  <done>Failure pattern chart implemented, 12+ tests covering all chart types and edge cases, all tests pass with >90% coverage</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] pytest tests/test_chart_generator.py passes all tests
- [ ] All 4 chart types generate valid PNG and SVG files
- [ ] Charts are professional quality with proper labels, legends, and formatting
- [ ] Edge cases handled gracefully (empty data, missing fields)
</verification>

<success_criteria>

- All tasks completed
- ChartGenerator class supports 4 chart types (equipment, seasonal, vendor, failure)
- Both PNG and SVG formats work for all charts
- Comprehensive test suite with 12+ tests passing
- Charts are publication-ready with professional styling
- No errors or warnings introduced
  </success_criteria>

<output>
After completion, create `.planning/phases/05-data-export-visualization/05-02-SUMMARY.md`
</output>
