---
phase: 02-equipment-category-analysis
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified: [src/analysis/outlier_detector.py, tests/test_outlier_detector.py]
autonomous: true
---

<objective>
Implement statistical outlier detection to identify equipment with abnormally high repair frequencies within their category.

Purpose: Use statistical methods (z-score, IQR) to flag equipment requiring attention based on frequency comparison to category peers.
Output: Outlier detection module that identifies high-maintenance equipment using multiple statistical approaches.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-equipment-category-analysis/02-01-SUMMARY.md

**From Plan 02-01:**
- Equipment frequencies calculated per month
- Category statistics available (mean, median, std dev)
- DataFrame structure: Equipment_ID, equipment_primary_category, work_orders_per_month, etc.

**Core value from PROJECT:**
Accurate identification of cost reduction opportunities - need reliable outlier detection

**Statistical approaches:**
- Z-score: Standard deviations from category mean
- IQR method: Values beyond Q3 + 1.5*IQR
- Percentile: Top N% in category
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement outlier detection methods</name>
  <files>src/analysis/outlier_detector.py, requirements.txt</files>
  <action>
Create outlier_detector.py with statistical detection functions:

**detect_zscore_outliers(freq_df, threshold=2.0):**
- For each equipment_primary_category group:
  - Calculate z-score: (work_orders_per_month - category_mean) / category_std
  - Flag as outlier if abs(z_score) > threshold (default 2.0 = ~95th percentile)
- Add columns: z_score, is_zscore_outlier (boolean)
- Handle categories with std=0 (all same frequency) - mark as not outliers
- Return DataFrame with outlier flags

**detect_iqr_outliers(freq_df):**
- For each equipment_primary_category group:
  - Calculate Q1 (25th percentile), Q3 (75th percentile)
  - Calculate IQR = Q3 - Q1
  - Flag as outlier if work_orders_per_month > Q3 + 1.5*IQR (upper outliers only)
- Add columns: is_iqr_outlier (boolean)
- IQR method more robust to skewed distributions than z-score
- Return DataFrame with outlier flags

**detect_percentile_outliers(freq_df, percentile=90):**
- For each equipment_primary_category group:
  - Calculate Nth percentile threshold
  - Flag equipment above threshold
- Add columns: is_percentile_outlier (boolean), percentile_rank (0-100)
- Simpler method: "top 10% in category"
- Return DataFrame with outlier flags

**detect_outliers(freq_df, methods=['zscore', 'iqr', 'percentile']):**
- Orchestrate all detection methods
- Apply each enabled method sequentially
- Add outlier_count column: sum of True flags across methods
- Add is_outlier_consensus: True if outlier_count >= 2 (majority vote)
- Return enriched DataFrame with all outlier flags
- Use scipy.stats for z-score calculations (add to requirements.txt)
  </action>
  <verify>python -c "from src.analysis.outlier_detector import detect_outliers; from src.analysis.frequency_analyzer import calculate_equipment_frequencies; from src.pipeline.pipeline import run_pipeline; df, _ = run_pipeline('input/adhoc_wo_20240101_20250531.xlsx - in.csv'); freq = calculate_equipment_frequencies(df); outliers = detect_outliers(freq); print(f'{outliers.is_outlier_consensus.sum()} consensus outliers found')" shows outlier count</verify>
  <done>Outlier detection uses z-score, IQR, and percentile methods with consensus flagging</done>
</task>

<task type="auto">
  <name>Task 2: Create tests for outlier detection</name>
  <files>tests/test_outlier_detector.py</files>
  <action>
Create tests/test_outlier_detector.py with pytest tests:

**test_detect_zscore_outliers:**
- Sample data: category with mean=10, std=2, equipment with frequency=15
- Z-score = (15-10)/2 = 2.5 (should be outlier with threshold=2.0)
- Verify is_zscore_outlier flagged correctly

**test_detect_zscore_outliers_zero_std:**
- Category where all equipment have same frequency (std=0)
- Verify no equipment flagged as outlier (avoid division by zero)

**test_detect_iqr_outliers:**
- Sample data with known Q1, Q3 values
- Equipment above Q3 + 1.5*IQR should be flagged
- Equipment within IQR should not be flagged

**test_detect_percentile_outliers:**
- 10 equipment with frequencies 1-10
- 90th percentile = 9
- Equipment with frequency 10 should be flagged
- Equipment 1-9 should not be flagged

**test_detect_outliers_consensus:**
- Equipment flagged by 2+ methods should have is_outlier_consensus=True
- Equipment flagged by only 1 method should have is_outlier_consensus=False
- Verify outlier_count sums correctly

Use numpy for creating test arrays if needed.
  </action>
  <verify>pytest tests/test_outlier_detector.py -v shows all tests passing</verify>
  <done>Test suite validates all outlier detection methods and consensus logic</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] src/analysis/outlier_detector.py implements all detection methods
- [ ] Z-score, IQR, and percentile methods available
- [ ] Consensus flagging combines multiple methods
- [ ] scipy added to requirements.txt
- [ ] pytest tests/test_outlier_detector.py passes
- [ ] Verification command shows consensus outliers
</verification>

<success_criteria>

- All tasks completed
- Multiple statistical methods implemented
- Consensus approach reduces false positives
- Tests validate detection logic
- Outliers identified reliably across categories
  </success_criteria>

<output>
After completion, create `.planning/phases/02-equipment-category-analysis/02-02-SUMMARY.md`
</output>
