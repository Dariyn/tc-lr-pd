---
phase: 02-equipment-category-analysis
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [src/analysis/frequency_analyzer.py, tests/test_frequency_analyzer.py]
autonomous: true
---

<objective>
Calculate work order frequencies for each equipment item within their category to identify repair patterns.

Purpose: Establish baseline frequency metrics that will enable statistical comparison and outlier detection in subsequent plans.
Output: Frequency analyzer module that groups equipment by category and calculates repair counts, rates, and distributions.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-data-pipeline-foundation/01-01-SUMMARY.md
@.planning/phases/01-data-pipeline-foundation/01-03-SUMMARY.md

**From Phase 1:**
- Data loaded via `src/pipeline/data_loader.py` - 19,291 work orders
- Categories normalized via `src/pipeline/categorizer.py` - 32 unique categories, 74 equipment items
- Each work order has: Equipment_ID, equipment_category, equipment_primary_category, Create_Date, Complete_Date

**Core requirement from PROJECT:**
Identify equipment with abnormally high adhoc repair frequencies within their category/type

**Available data (from Phase 1 summaries):**
- equipment_category: Normalized category field
- equipment_primary_category: Most frequent category for each equipment
- equipment_category_consistency: % of work orders in primary category
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create frequency analysis module structure</name>
  <files>src/analysis/__init__.py, src/analysis/frequency_analyzer.py</files>
  <action>
Create src/analysis/ directory for analysis modules.

Create frequency_analyzer.py with core functions:

**calculate_equipment_frequencies(df):**
- Group by equipment_primary_category and Equipment_ID
- Calculate for each equipment:
  - total_work_orders: count of work orders
  - timespan_days: (max Create_Date - min Create_Date).days + 1
  - work_orders_per_month: (total_work_orders / timespan_days) * 30.44 avg days/month
  - avg_completion_days: mean of (Complete_Date - Create_Date) where both exist
  - avg_cost: mean of PO_AMOUNT where > 0
- Return DataFrame with columns: [Equipment_ID, equipment_primary_category, total_work_orders, timespan_days, work_orders_per_month, avg_completion_days, avg_cost]
- Handle edge cases: single work order (timespan=1), missing dates (use available), zero costs (exclude from avg)

**calculate_category_statistics(freq_df):**
- Group by equipment_primary_category
- Calculate category-level statistics:
  - equipment_count: unique equipment in category
  - total_work_orders: sum across all equipment
  - mean_frequency: mean work_orders_per_month
  - median_frequency: median work_orders_per_month
  - std_frequency: std dev of work_orders_per_month
  - min_frequency, max_frequency
- Return DataFrame with category stats
- Use for baseline comparison in outlier detection
  </action>
  <verify>python -c "from src.analysis.frequency_analyzer import calculate_equipment_frequencies; from src.pipeline.pipeline import run_pipeline; df, _ = run_pipeline('input/adhoc_wo_20240101_20250531.xlsx - in.csv'); freq = calculate_equipment_frequencies(df); print(f'{len(freq)} equipment analyzed')" shows equipment count</verify>
  <done>Frequency analysis functions calculate work order rates and category baselines</done>
</task>

<task type="auto">
  <name>Task 2: Create tests for frequency calculations</name>
  <files>tests/test_frequency_analyzer.py</files>
  <action>
Create tests/test_frequency_analyzer.py with pytest tests:

**test_calculate_equipment_frequencies_basic:**
- Create sample DataFrame with known equipment and dates
- Verify total_work_orders counted correctly
- Verify timespan_days calculated from date range
- Verify work_orders_per_month formula: (count / days) * 30.44

**test_calculate_equipment_frequencies_single_order:**
- Equipment with only 1 work order
- Verify timespan_days defaults to 1
- Verify work_orders_per_month calculated correctly

**test_calculate_equipment_frequencies_missing_dates:**
- Work orders with missing Complete_Date
- Verify avg_completion_days handles nulls (uses only valid data)

**test_calculate_category_statistics:**
- Sample frequency DataFrame with multiple equipment per category
- Verify mean, median, std dev calculated correctly
- Verify equipment_count and total_work_orders aggregated properly

Use simple assert statements with small test DataFrames for clear validation.
  </action>
  <verify>pytest tests/test_frequency_analyzer.py -v shows all tests passing</verify>
  <done>Test suite validates frequency calculations and category statistics</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] src/analysis/frequency_analyzer.py implements frequency calculations
- [ ] Equipment frequencies calculated per month for normalization
- [ ] Category statistics provide baseline for comparison
- [ ] pytest tests/test_frequency_analyzer.py passes
- [ ] Verification command shows equipment analyzed
</verification>

<success_criteria>

- All tasks completed
- Frequency metrics calculated for all equipment
- Category baselines established for outlier detection
- Tests validate calculation logic
- No errors during frequency analysis
  </success_criteria>

<output>
After completion, create `.planning/phases/02-equipment-category-analysis/02-01-SUMMARY.md`
</output>
