---
phase: 04-reporting-engine
plan: 03
type: execute
wave: 2
depends_on: ["04-01"]
files_modified: [src/reporting/excel_generator.py, tests/test_excel_generator.py, requirements.txt]
autonomous: true
---

<objective>
Generate formatted Excel reports with multiple sheets, conditional formatting, and data tables using xlsxwriter.

Purpose: Create Excel output for stakeholders who need interactive, sortable data with detailed analysis that can be further manipulated.
Output: ExcelReportGenerator class that converts Report objects into formatted Excel workbooks.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
@~/.claude/get-shit-done/references/tdd.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior plan context
@.planning/phases/04-reporting-engine/04-01-SUMMARY.md

# Relevant files
@src/reporting/report_builder.py

**From Plan 04-01:**
- Report data model with sections
- ReportBuilder that aggregates all analyses
- Structured data ready for rendering

**Excel Library Choice: xlsxwriter**
Selected based on research:
- Optimized for creating new formatted Excel files
- Superior performance with large datasets
- Rich formatting options (colors, fonts, borders, conditional formatting)
- Chart and graph support
- Works well with pandas DataFrames

**Excel Workbook Structure:**
- Sheet 1: Summary - Executive summary with key metrics
- Sheet 2: Equipment - Ranked equipment with priority scores
- Sheet 3: Seasonal - Monthly/quarterly cost patterns
- Sheet 4: Vendors - Vendor performance metrics
- Sheet 5: Failures - Failure patterns and costs
- Sheet 6: Recommendations - All recommendations consolidated

**Formatting Standards:**
- Header row: Bold, dark blue background (#1f4788), white text
- Data rows: Alternating white and light gray (#f0f0f0)
- Currency columns: $ format with comma separators
- Percentage columns: % format with 1 decimal place
- Number columns: Comma separators for thousands
- Column auto-width based on content
- Freeze top row (headers) for scrolling
- Add filters to header rows
</context>

<tasks>

<task type="auto">
  <name>Task 1: Set up xlsxwriter and implement workbook structure</name>
  <files>requirements.txt, src/reporting/excel_generator.py</files>
  <action>
Add xlsxwriter to requirements.txt:
```
xlsxwriter==3.2.0
```

Create ExcelReportGenerator class:
- __init__(): Initialize class with format definitions
- generate_excel(report, output_file): Main entry point, creates workbook and all sheets
- _create_formats(workbook): Define reusable cell formats (header, data, currency, percentage, etc.)
- _add_summary_sheet(workbook, report): Executive summary with key metrics in table format
- _add_data_sheet(workbook, sheet_name, dataframe, title): Generic sheet creator with formatted table
- _set_column_widths(worksheet, dataframe): Auto-size columns based on content

Cell formats to define:
- header_format: bold=True, bg_color='#1f4788', font_color='white', border=1
- data_format: border=1
- data_alt_format: bg_color='#f0f0f0', border=1 (alternating rows)
- currency_format: num_format='$#,##0', border=1
- percentage_format: num_format='0.0%', border=1
- integer_format: num_format='#,##0', border=1

Use xlsxwriter's write_row, write_column for efficient bulk writes.
Apply conditional formatting for priority scores (green high, yellow medium, red low).
  </action>
  <verify>Import ExcelReportGenerator, create instance, verify methods exist</verify>
  <done>ExcelReportGenerator class with workbook structure methods implemented</done>
</task>

<task type="auto">
  <name>Task 2: Implement sheet rendering for all analysis types</name>
  <files>src/reporting/excel_generator.py</files>
  <action>
Add specialized sheet renderers:
- _add_equipment_sheet(workbook, section): Equipment ranking table with columns: Equipment_ID, Category, WO/Month, Total Cost, Avg Cost, Cost Impact, Priority Score. Apply conditional formatting to Priority column (0.7-1.0=green, 0.4-0.7=yellow, <0.4=red). Include threshold values in header notes.

- _add_seasonal_sheet(workbook, section): Two tables - Monthly costs (Month, Total Cost, WO Count, Avg Cost, Variance %) and Quarterly costs (Quarter, Total Cost, WO Count, Avg Cost, Variance %). Add detected patterns as text below tables.

- _add_vendor_sheet(workbook, section): Vendor performance table with columns: Contractor, Total Cost, WO Count, Avg Cost, Avg Duration Days, Cost Efficiency, Quality Score. Apply conditional formatting to Cost Efficiency (lower=better, green <200, yellow 200-500, red >500).

- _add_failure_sheet(workbook, section): Failure patterns table with columns: Pattern, Failure Category, Occurrences, Total Cost, Avg Cost, Equipment Affected, Impact Score. Sort by Impact Score descending. Apply conditional formatting to Impact Score (top 10%=red, next 20%=yellow).

- _add_recommendations_sheet(workbook, all_sections): Consolidated recommendations table with columns: Source (Equipment/Seasonal/Vendor/Failure), Priority (High/Medium/Low), Recommendation Text, Expected Impact.

Each sheet should:
1. Write header row with formatting
2. Write data rows with alternating background colors
3. Apply appropriate number formats to numeric columns
4. Set column widths for readability
5. Freeze top row
6. Add autofilter to header row
7. Add sheet protection (optional, allow filtering/sorting only)

Handle missing data: Display "N/A" for null values, skip empty sections with note.
  </action>
  <verify>Call sheet renderers with sample Report object, verify Excel structure</verify>
  <done>All sheet renderers working, producing formatted Excel workbook</done>
</task>

<task type="auto">
  <name>Task 3: Create comprehensive test suite</name>
  <files>tests/test_excel_generator.py</files>
  <action>
Create test suite with pytest covering:
- Excel workbook creation
- Format definitions (header, data, currency, percentage)
- Summary sheet with key metrics
- Equipment sheet with conditional formatting
- Seasonal sheet with multiple tables
- Vendor sheet with performance metrics
- Failure sheet with patterns and scores
- Recommendations sheet with consolidated items
- Column width auto-sizing
- Full workbook generation with all sheets
- Output file creation and validation
- Edge cases: empty DataFrames, missing columns, null values

Use mock Report objects with known data.
Verify Excel file exists and has correct sheet count.
Use openpyxl to read generated file and verify structure (xlsxwriter writes, openpyxl reads).
Validate: sheet names, row counts, column headers, cell values.

Don't test pixel-perfect formatting - focus on data accuracy and structure.
  </action>
  <verify>pytest tests/test_excel_generator.py passes all tests</verify>
  <done>15+ tests covering Excel generation and formatting, all passing</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] pytest tests/test_excel_generator.py passes
- [ ] xlsxwriter added to requirements.txt
- [ ] ExcelReportGenerator can create multi-sheet workbook
- [ ] All analysis sections render as separate sheets
- [ ] Conditional formatting applied appropriately
- [ ] Excel file is created at specified output path
- [ ] File can be opened in Excel/LibreOffice
- [ ] No import errors or type issues
</verification>

<success_criteria>

- All tasks completed
- All tests pass
- ExcelReportGenerator class fully functional
- Excel output is professional with proper formatting
- All analysis findings included across sheets
- Conditional formatting highlights key metrics
  </success_criteria>

<output>
After completion, create `.planning/phases/04-reporting-engine/04-03-SUMMARY.md`
</output>
