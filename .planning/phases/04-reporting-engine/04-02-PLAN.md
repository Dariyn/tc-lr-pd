---
phase: 04-reporting-engine
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified: [src/reporting/pdf_generator.py, tests/test_pdf_generator.py, requirements.txt]
autonomous: true
---

<objective>
Generate professional PDF reports with tables, formatting, and recommendations using fpdf2.

Purpose: Create PDF output capability for stakeholders who need printable/shareable reports with equipment rankings, cost patterns, and actionable recommendations.
Output: PDFReportGenerator class that converts Report objects into formatted PDF files.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
@~/.claude/get-shit-done/references/tdd.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior plan context
@.planning/phases/04-reporting-engine/04-01-SUMMARY.md

# Relevant files
@src/reporting/report_builder.py

**From Plan 04-01:**
- Report data model with sections
- ReportBuilder that aggregates all analyses
- Structured data ready for rendering

**PDF Library Choice: fpdf2**
Selected based on research:
- Pure Python, no external dependencies
- Fast and efficient for tabular reports
- Easy to use for simple formatting
- Lightweight compared to ReportLab/WeasyPrint
- Perfect for text and table-based reports

**PDF Report Layout:**
1. Cover page with title, date, summary metrics
2. Table of contents
3. Executive summary (1 page)
4. Equipment analysis section (tables + text)
5. Seasonal patterns section (tables + text)
6. Vendor performance section (tables + text)
7. Failure patterns section (tables + text)
8. Recommendations summary (bulleted list)
9. Footer with page numbers and generation timestamp
</context>

<tasks>

<task type="auto">
  <name>Task 1: Set up fpdf2 and implement PDF structure</name>
  <files>requirements.txt, src/reporting/pdf_generator.py</files>
  <action>
Add fpdf2 to requirements.txt:
```
fpdf2==2.7.9
```

Create PDFReportGenerator class:
- __init__(): Initialize FPDF with A4 page size, portrait orientation
- generate_pdf(report, output_file): Main entry point, orchestrates PDF generation
- _add_cover_page(report): Title, date, key metrics summary
- _add_table_of_contents(report): Section list with page numbers (placeholder for manual entry)
- _add_section(section): Generic section renderer with title, content tables, recommendations
- _format_table(df, max_rows=20): Convert DataFrame to formatted PDF table with headers, borders, alternating row colors
- _add_page_footer(): Page number, generation timestamp

Formatting standards:
- Title font: Arial Bold 16pt
- Headers: Arial Bold 12pt
- Body text: Arial 10pt
- Tables: 9pt with borders, alternating white/light gray rows
- Margins: 20mm all sides
- Colors: Dark blue headers (#1f4788), light gray alternating rows (#f0f0f0)

Handle page breaks: Auto-insert when content exceeds page height.
Include "Generated by Work Order Analysis Pipeline" in footer.
  </action>
  <verify>Import PDFReportGenerator, create instance, verify methods exist</verify>
  <done>PDFReportGenerator class with structure methods implemented</done>
</task>

<task type="auto">
  <name>Task 2: Implement section rendering for all analysis types</name>
  <files>src/reporting/pdf_generator.py</files>
  <action>
Add specialized section renderers:
- _add_executive_summary(summary_dict): Multi-column layout with key metrics in boxes
- _add_equipment_section(section): Ranked equipment table (Equipment_ID, Category, WO/Month, Cost Impact, Priority), top 10 only, thresholds as text
- _add_seasonal_section(section): Monthly/quarterly tables, detected patterns as bulleted list
- _add_vendor_section(section): Vendor performance table (Contractor, Total Cost, Avg Cost, WO Count, Efficiency), top 15 vendors
- _add_failure_section(section): High-impact patterns table (Pattern, Occurrences, Total Cost, Avg Cost), top 20 patterns
- _add_recommendations_page(all_recommendations): Consolidated bullet list from all sections

Each section should:
1. Add section header with title
2. Add summary text if provided
3. Render data tables with proper column widths
4. Add recommendations as bulleted list
5. Insert page break after section

Column widths for tables:
- Equipment: 30mm, 60mm, 25mm, 30mm, 25mm
- Vendor: 50mm, 30mm, 30mm, 25mm, 25mm
- Patterns: 70mm, 25mm, 30mm, 30mm

Use fpdf2's table features or manual cell positioning for clean tables.
  </action>
  <verify>Call section renderers with sample Report object, verify PDF structure</verify>
  <done>All section renderers working, producing formatted PDF output</done>
</task>

<task type="auto">
  <name>Task 3: Create comprehensive test suite</name>
  <files>tests/test_pdf_generator.py</files>
  <action>
Create test suite with pytest covering:
- PDF initialization with correct page settings
- Cover page generation with metadata
- Table formatting with DataFrame input
- Executive summary rendering
- Equipment section with ranked data
- Seasonal section with patterns
- Vendor section with metrics
- Failure section with patterns
- Recommendations page with multiple sources
- Full PDF generation with all sections
- Output file creation and validation
- Edge cases: empty sections, long text wrapping, table pagination

Use mock Report objects with known data.
Verify PDF output exists and has expected page count (manual inspection for formatting).
Don't test pixel-perfect rendering - focus on structure and data presence.

Note: fpdf2 tests may just verify file creation and basic structure.
Full PDF validation would require external library - out of scope.
  </action>
  <verify>pytest tests/test_pdf_generator.py passes all tests</verify>
  <done>12+ tests covering PDF generation and formatting, all passing</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] pytest tests/test_pdf_generator.py passes
- [ ] fpdf2 added to requirements.txt
- [ ] PDFReportGenerator can create multi-page PDF
- [ ] All analysis sections render properly
- [ ] Tables are formatted and readable
- [ ] PDF file is created at specified output path
- [ ] No import errors or type issues
</verification>

<success_criteria>

- All tasks completed
- All tests pass
- PDFReportGenerator class fully functional
- PDF output is professional and readable
- All analysis findings included in PDF
  </success_criteria>

<output>
After completion, create `.planning/phases/04-reporting-engine/04-02-SUMMARY.md`
</output>
