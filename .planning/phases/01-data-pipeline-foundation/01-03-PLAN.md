---
phase: 01-data-pipeline-foundation
plan: 03
type: execute
wave: 2
depends_on: ["01-01"]
files_modified: [src/pipeline/categorizer.py, tests/test_categorizer.py]
autonomous: true
---

<objective>
Implement category and type normalization to ensure consistent equipment categorization for cross-category comparisons.

Purpose: Enable accurate "equipment within same category" comparisons by establishing normalized category hierarchies and handling inconsistencies.
Output: Categorization module that creates standardized equipment categories and types for analysis.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-data-pipeline-foundation/01-01-SUMMARY.md

**Core requirement from PROJECT:** Identify equipment with abnormally high adhoc repair frequencies within their category/type

**Available categorization fields (from schema):**
- Property_category (Category1, Category2, etc.)
- FM_Type (Fitter Services, etc.)
- Work_Order_Type (Adhoc WO, etc.)
- service_type_lv1, service_type_lv2, service_type_lv3 (hierarchical classification)

**Challenge:** Equipment may have inconsistent categorization, null categories, or multiple classification schemes
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement category normalization</name>
  <files>src/pipeline/categorizer.py</files>
  <action>
Create categorizer.py with category normalization functions:

**normalize_categories(df):**
- Create equipment_category field by priority:
  1. Use service_type_lv2 if not null (most specific useful level)
  2. Fall back to FM_Type if service_type_lv2 is null
  3. Fall back to 'Uncategorized' if both null
- Create equipment_subcategory using service_type_lv3 (most granular), fallback to service_type_lv2, then 'General'
- Strip whitespace and standardize casing (title case) for consistency
- Handle Chinese/English mixed text: preserve as-is, just strip whitespace

**create_category_hierarchy(df):**
- Group by equipment_category and count unique Equipment_IDs
- Return DataFrame with: category, equipment_count, work_order_count
- Sort by work_order_count descending
- This helps identify which categories have sufficient data for statistical analysis

**assign_equipment_types(df):**
- Group by Equipment_ID to assign primary category (mode of equipment_category for that equipment)
- Some equipment may appear in multiple categories if miscategorized - use most frequent
- Add equipment_primary_category column to original df
- Add equipment_category_consistency score: % of work orders in primary category
- Flag equipment with consistency < 80% as potentially miscategorized

**categorize_work_orders(df):**
- Orchestrate all categorization: normalize → create hierarchy → assign equipment types
- Return df with added columns: equipment_category, equipment_subcategory, equipment_primary_category, equipment_category_consistency
- Log categorization statistics: unique categories, uncategorized count, consistency distribution
  </action>
  <verify>python -c "from src.pipeline.categorizer import categorize_work_orders; from src.pipeline.data_loader import load_work_orders; df = load_work_orders('input/adhoc_wo_20240101_20250531.xlsx - in.csv'); cat_df = categorize_work_orders(df); print(f'{cat_df.equipment_category.nunique()} unique categories')" shows category count</verify>
  <done>Categorization functions create normalized equipment categories and assign equipment to primary categories</done>
</task>

<task type="auto">
  <name>Task 2: Create tests for categorization logic</name>
  <files>tests/test_categorizer.py</files>
  <action>
Create tests/test_categorizer.py with pytest tests:
- test_normalize_categories_uses_priority: Verify service_type_lv2 preferred over FM_Type
- test_normalize_categories_handles_nulls: Verify fallback to 'Uncategorized'
- test_create_category_hierarchy: Verify hierarchy counts equipment and work orders correctly
- test_assign_equipment_types_finds_primary: Verify mode category assigned as primary
- test_assign_equipment_types_calculates_consistency: Verify consistency score calculation
- Use sample DataFrames with known categories to verify logic
  </action>
  <verify>pytest tests/test_categorizer.py -v shows all tests passing</verify>
  <done>Test suite validates categorization priority, fallback handling, and equipment type assignment</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] src/pipeline/categorizer.py implements categorization functions
- [ ] Categories normalized with clear priority/fallback logic
- [ ] Equipment assigned to primary categories with consistency scores
- [ ] pytest tests/test_categorizer.py passes
- [ ] Verification command shows categories created
</verification>

<success_criteria>

- All tasks completed
- Category normalization handles mixed data sources
- Equipment primary category assignment works correctly
- Category hierarchy provides analysis-ready groupings
- Tests validate categorization logic
  </success_criteria>

<output>
After completion, create `.planning/phases/01-data-pipeline-foundation/01-03-SUMMARY.md`
</output>
