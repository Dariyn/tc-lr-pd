---
phase: 03-cost-pattern-analysis
plan: 02
type: execute
wave: 1
depends_on: []
files_modified: [src/analysis/vendor_analyzer.py, tests/test_vendor_analyzer.py]
autonomous: true
---

<objective>
Analyze vendor/contractor cost performance to identify high-cost vendors and efficiency patterns.

Purpose: Identify which vendors have highest costs, longest completion times, or quality issues to inform vendor selection and contract negotiations.
Output: Vendor analysis module that aggregates costs by contractor and calculates performance metrics.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
@~/.claude/get-shit-done/references/tdd.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior phase context
@.planning/phases/01-data-pipeline-foundation/01-01-SUMMARY.md
@.planning/phases/01-data-pipeline-foundation/01-02-SUMMARY.md

# Relevant source files
@src/pipeline/schema.py
@src/pipeline/data_loader.py

**Available vendor fields:**
- Contractor: Vendor/contractor name
- contract_id: Contract identifier

**From Phase 1:**
- Data loading infrastructure
- PO_AMOUNT for cost analysis
- Create_Date and Complete_Date for duration calculation

**Analysis approach:**
- Group by Contractor, aggregate costs and counts
- Calculate average cost per work order by vendor
- Calculate average completion time by vendor
- Identify high-cost and slow vendors for review
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement vendor aggregation and metrics</name>
  <files>src/analysis/vendor_analyzer.py</files>
  <action>
Create VendorAnalyzer class with methods:
- calculate_vendor_costs(df): Group by Contractor, return total_cost, work_order_count, avg_cost_per_wo
- calculate_vendor_duration(df): Group by Contractor, calculate avg completion days (Complete_Date - Create_Date)
- rank_vendors(df, by='total_cost'): Rank vendors by total cost, avg cost, or work order count
- identify_high_cost_vendors(df, threshold='75th_percentile'): Flag vendors above cost threshold

Handle missing Contractor values: group as "Unknown" or skip based on parameter.
Filter to vendors with minimum work order count (default: 3) to avoid one-off outliers.

Return DataFrames with columns: contractor, total_cost, wo_count, avg_cost, avg_duration_days, rank.
</action>
  <verify>Import VendorAnalyzer, call methods with sample data, verify output structure</verify>
  <done>VendorAnalyzer class with all four methods returning proper DataFrames</done>
</task>

<task type="auto">
  <name>Task 2: Add cost efficiency and quality indicators</name>
  <files>src/analysis/vendor_analyzer.py</files>
  <action>
Add to VendorAnalyzer:
- calculate_cost_efficiency(df): Cost per day (avg_cost / avg_duration) - lower is better
- calculate_quality_indicators(df): If Problem/Remedy fields available, count repeat issues for same equipment
- get_vendor_recommendations(df): Generate recommendations based on metrics

Cost efficiency helps identify vendors who complete work quickly at reasonable cost.
Quality indicators flag vendors with recurring issues on same equipment (potential rework).

Recommendations format:
[{"vendor": "ABC Corp", "issue": "High cost", "metric": "$5000 avg", "suggestion": "Review contract terms"}]

Handle edge cases: vendors with single work order, missing duration data.
</action>
  <verify>Call calculate_cost_efficiency and get_vendor_recommendations, verify output</verify>
  <done>Efficiency and quality methods work, return structured recommendations</done>
</task>

<task type="auto">
  <name>Task 3: Create comprehensive test suite</name>
  <files>tests/test_vendor_analyzer.py</files>
  <action>
Create test suite with pytest covering:
- Vendor aggregation with known costs (3 vendors, varying costs)
- Average duration calculation with date ranges
- Ranking by different criteria (total cost, avg cost, work order count)
- High-cost vendor identification at different percentile thresholds
- Cost efficiency calculation
- Minimum work order threshold filtering
- Edge cases: missing Contractor, single vendor, tie in rankings, zero duration

Use pandas testing utilities for DataFrame comparisons.
Create synthetic test data with clear expected outcomes.
</action>
  <verify>pytest tests/test_vendor_analyzer.py passes all tests</verify>
  <done>10+ tests covering all functions and edge cases, all passing</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] pytest tests/test_vendor_analyzer.py passes
- [ ] VendorAnalyzer can process sample work order data
- [ ] Vendor ranking produces correct order
- [ ] Cost efficiency calculation handles edge cases
- [ ] Recommendations are actionable
- [ ] No import errors or type issues
</verification>

<success_criteria>

- All tasks completed
- All tests pass
- VendorAnalyzer class fully functional
- Vendor recommendations are actionable
- Code handles missing vendor data gracefully
  </success_criteria>

<output>
After completion, create `.planning/phases/03-cost-pattern-analysis/03-02-SUMMARY.md`
</output>
