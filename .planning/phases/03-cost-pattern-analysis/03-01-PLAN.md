---
phase: 03-cost-pattern-analysis
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [src/analysis/seasonal_analyzer.py, tests/test_seasonal_analyzer.py]
autonomous: true
---

<objective>
Analyze seasonal trends in work order costs to identify patterns across months, quarters, and seasons.

Purpose: Identify seasonal cost patterns (e.g., higher costs in summer for HVAC, winter for heating) to inform budget planning and preventive scheduling.
Output: Seasonal analysis module that aggregates costs by time periods and identifies significant seasonal variations.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
@~/.claude/get-shit-done/references/tdd.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior phase context
@.planning/phases/01-data-pipeline-foundation/01-01-SUMMARY.md

# Relevant source files
@src/pipeline/schema.py
@src/pipeline/data_loader.py

**Available date fields:**
- Create_Date: Work order creation date
- Complete_Date: Work order completion date
- Request_Create_Date: Original request date

**From Phase 1:**
- Data loading infrastructure with pandas
- Date fields properly parsed as datetime objects
- PO_AMOUNT field for cost analysis

**Analysis approach:**
- Group by completion month/quarter/season for temporal patterns
- Compare costs across same periods to identify recurring trends
- Calculate percentage variation from average to highlight peaks
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement seasonal aggregation functions</name>
  <files>src/analysis/seasonal_analyzer.py</files>
  <action>
Create SeasonalAnalyzer class with methods:
- calculate_monthly_costs(df): Group by month (Complete_Date), sum PO_AMOUNT
- calculate_quarterly_costs(df): Group by quarter (Q1-Q4), sum PO_AMOUNT
- calculate_seasonal_costs(df): Group by season (Winter/Spring/Summer/Fall), sum PO_AMOUNT
- identify_peaks(series, threshold=1.2): Flag periods where cost exceeds average * threshold

Use pandas groupby with dt.month, dt.quarter, and dt.month mapping to seasons.
Return DataFrames with period, total_cost, avg_cost, work_order_count columns.

Include docstrings with parameter types and return formats.
Handle edge cases: empty dataframes, single period data, missing dates.
</action>
  <verify>Import SeasonalAnalyzer, call methods with sample data, verify DataFrame structure</verify>
  <done>SeasonalAnalyzer class exists with all four methods returning proper DataFrames</done>
</task>

<task type="auto">
  <name>Task 2: Add trend analysis and variance calculation</name>
  <files>src/analysis/seasonal_analyzer.py</files>
  <action>
Add to SeasonalAnalyzer:
- calculate_variance(df): For each period, calculate percentage variance from overall average
- detect_patterns(df, min_occurrences=2): Identify recurring patterns (e.g., "Q3 always high")
- get_recommendations(df): Generate text recommendations based on detected patterns

Return format for detect_patterns:
[{"pattern": "High costs in Q3", "confidence": "high", "occurrences": 3, "avg_variance": "+35%"}]

Recommendations should be actionable (e.g., "Consider preventive maintenance before Q3" for high Q3 costs).
</action>
  <verify>Call detect_patterns and get_recommendations, verify output structure</verify>
  <done>Variance calculation and pattern detection methods work, return structured data</done>
</task>

<task type="auto">
  <name>Task 3: Create comprehensive test suite</name>
  <files>tests/test_seasonal_analyzer.py</files>
  <action>
Create test suite with pytest covering:
- Monthly aggregation with known data (12 work orders across 12 months)
- Quarterly aggregation (4 quarters)
- Seasonal mapping (verify Winter=Dec/Jan/Feb, etc.)
- Peak detection with threshold variations
- Variance calculation accuracy
- Pattern detection with recurring high costs
- Edge cases: empty DataFrame, single record, missing dates, all costs same

Use pandas testing utilities (assert_frame_equal) for DataFrame comparisons.
Mock or use small synthetic datasets with known patterns.
</action>
  <verify>pytest tests/test_seasonal_analyzer.py passes all tests</verify>
  <done>10+ tests covering all functions and edge cases, all passing</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] pytest tests/test_seasonal_analyzer.py passes
- [ ] SeasonalAnalyzer can process sample work order data
- [ ] Monthly, quarterly, and seasonal aggregations produce correct output
- [ ] Pattern detection identifies known seasonal trends
- [ ] No import errors or type issues
</verification>

<success_criteria>

- All tasks completed
- All tests pass
- SeasonalAnalyzer class fully functional
- Pattern detection produces actionable insights
- Code follows pandas best practices
  </success_criteria>

<output>
After completion, create `.planning/phases/03-cost-pattern-analysis/03-01-SUMMARY.md`
</output>
