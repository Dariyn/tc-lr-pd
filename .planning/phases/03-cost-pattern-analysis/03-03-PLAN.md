---
phase: 03-cost-pattern-analysis
plan: 03
type: execute
wave: 1
depends_on: []
files_modified: [src/analysis/failure_pattern_analyzer.py, tests/test_failure_pattern_analyzer.py]
autonomous: true
---

<objective>
Extract and analyze failure patterns from work order text fields to identify recurring issues.

Purpose: Identify common failure types, root causes, and recurring problems to prioritize preventive maintenance and equipment upgrades.
Output: Failure pattern analyzer that extracts patterns from Problem/Cause/Remedy/description fields and identifies frequently occurring issues.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
@~/.claude/get-shit-done/references/tdd.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior phase context
@.planning/phases/01-data-pipeline-foundation/01-01-SUMMARY.md
@.planning/phases/01-data-pipeline-foundation/01-02-SUMMARY.md

# Relevant source files
@src/pipeline/schema.py
@src/pipeline/data_loader.py

**Available text fields for pattern extraction:**
- Problem: Problem description
- Cause: Cause of the problem
- Remedy: Remedy applied
- description: General description

**From Phase 1:**
- Data loading infrastructure
- Text fields available for analysis
- Equipment categorization for grouping patterns

**Analysis approach:**
- Extract keywords and phrases from text fields
- Group by equipment category to find category-specific patterns
- Count frequency of failure types
- Identify recurring issues on specific equipment
- Use simple text processing (not ML) - word frequency, common phrases
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement text extraction and pattern identification</name>
  <files>src/analysis/failure_pattern_analyzer.py</files>
  <action>
Create FailurePatternAnalyzer class with methods:
- extract_keywords(text, min_length=3): Extract meaningful words (filter stopwords, short words)
- find_common_phrases(df, field='Problem', top_n=20): Find most common 2-3 word phrases
- categorize_by_failure_type(df): Group failures into categories (leak, broken, malfunction, electrical, etc.)
- identify_recurring_issues(df, by_equipment=True): Find equipment with repeated same failures

Use simple string operations: lower(), split(), Counter from collections.
Common failure keywords to detect: leak, broken, fault, malfunction, damaged, not working, failure, noise, etc.

Return DataFrames with columns: pattern, frequency, category, avg_cost, example_wo_numbers.
Handle mixed language text (Chinese/English) - use basic keyword matching for English, preserve Chinese for review.
</action>
  <verify>Import FailurePatternAnalyzer, call methods with sample data, verify pattern extraction</verify>
  <done>FailurePatternAnalyzer class with keyword extraction and phrase detection working</done>
</task>

<task type="auto">
  <name>Task 2: Add frequency analysis and cost correlation</name>
  <files>src/analysis/failure_pattern_analyzer.py</files>
  <action>
Add to FailurePatternAnalyzer:
- calculate_pattern_costs(df): For each identified pattern, calculate total and average cost
- find_high_impact_patterns(df, min_occurrences=5): Patterns occurring frequently with high costs
- get_pattern_recommendations(df): Generate recommendations for recurring high-cost patterns

High-impact patterns are those with:
- Frequency >= min_occurrences (recurring issue)
- Average cost above median (expensive to fix)
- Affecting multiple equipment items (not isolated)

Recommendations format:
[{"pattern": "HVAC refrigerant leak", "occurrences": 12, "total_cost": "$18000",
  "suggestion": "Inspect all HVAC systems for refrigerant levels preventively"}]

Correlate with equipment categories to make category-specific recommendations.
</action>
  <verify>Call find_high_impact_patterns and get_pattern_recommendations, verify output</verify>
  <done>Pattern cost analysis and recommendations working with structured output</done>
</task>

<task type="auto">
  <name>Task 3: Create comprehensive test suite</name>
  <files>tests/test_failure_pattern_analyzer.py</files>
  <action>
Create test suite with pytest covering:
- Keyword extraction with known text (filter stopwords, preserve meaningful words)
- Common phrase detection with repeated phrases in test data
- Failure type categorization (verify "leak" → leak category, "broken" → damage category)
- Recurring issue identification for same equipment
- Pattern cost calculation with known costs
- High-impact pattern filtering with various thresholds
- Mixed language handling (English + Chinese text)
- Edge cases: empty text fields, single-word descriptions, no patterns found

Use synthetic test data with clear patterns (e.g., 5 "HVAC leak" failures, 3 "elevator malfunction").
Verify pattern frequency counts and cost aggregations.
</action>
  <verify>pytest tests/test_failure_pattern_analyzer.py passes all tests</verify>
  <done>10+ tests covering all functions and edge cases, all passing</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] pytest tests/test_failure_pattern_analyzer.py passes
- [ ] FailurePatternAnalyzer extracts keywords correctly
- [ ] Common phrases identified with frequency counts
- [ ] Pattern costs calculated accurately
- [ ] High-impact patterns flagged appropriately
- [ ] Recommendations are actionable
- [ ] No import errors or type issues
</verification>

<success_criteria>

- All tasks completed
- All tests pass
- FailurePatternAnalyzer class fully functional
- Pattern extraction handles mixed language text
- High-impact patterns identified with cost correlation
- Recommendations are specific and actionable
  </success_criteria>

<output>
After completion, create `.planning/phases/03-cost-pattern-analysis/03-03-SUMMARY.md`
</output>
